import React, { useState, useEffect } from 'react';
import { View, ScrollView, TouchableOpacity, Linking } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { router } from 'expo-router';
import * as WebBrowser from 'expo-web-browser';
import { Text } from '@/components/ui/text';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { supabase } from '@/lib/core/supabase';
import { useAuth } from '@/hooks';

export default function StripeTestScreen() {
  const { user } = useAuth();
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState<string>('');
  const [lastCreateResult, setLastCreateResult] = useState<string | null>(null);

  // Log when component mounts
  useEffect(() => {
    console.log('üß™ [Stripe Test] Component mounted');
    console.log('üß™ [Stripe Test] User:', user?.id || 'No user');
    console.log('üß™ [Stripe Test] User email:', user?.email || 'No email');
  }, [user]);

  const testCreateStripeAccount = async () => {
    console.log('üß™ [Test] Starting Stripe account creation test...');
    
    if (!user?.id) {
      console.log('‚ùå [Test] No user logged in');
      setResult('‚ùå No user logged in');
      return;
    }

    console.log('üß™ [Test] User ID:', user.id);
    setLoading(true);
    setResult('üîÑ Creating Stripe account...');

    try {
      console.log('üß™ [Test] Invoking create-stripe-account Edge Function...');
      const { data, error } = await supabase.functions.invoke('create-stripe-account', {
        body: { user_id: user.id }
      });

      console.log('üß™ [Test] Edge Function response:', { data, error });

      if (error) {
        console.log('‚ùå [Test] Error from Edge Function:', error);
        setResult(`‚ùå Error: ${error.message}`);
        setLastCreateResult(null);
      } else {
        console.log('‚úÖ [Test] Success! Account created:', data.stripeAccountId);
        console.log('üîó [Test] Onboarding URL:', data.accountLink);
        console.log('üí∞ [Test] Commission Rate:', data.commissionRate);
        console.log('üìÖ [Test] Payout Schedule:', data.payoutSchedule);
        console.log('üí∑ [Test] Minimum Payout:', data.minimumPayout);
        const successMessage = `‚úÖ SUCCESS! Stripe account created!\n\nAccount ID: ${data.stripeAccountId}\nCommission: ${data.commissionRate}\nPayout: ${data.payoutSchedule}\nMinimum: ${data.minimumPayout}\n\nüîó Onboarding URL:\n${data.accountLink}`;
        setResult(successMessage);
        setLastCreateResult(data.stripeAccountId);
      }
    } catch (error) {
      console.log('üí• [Test] Exception caught:', error);
      setResult(`‚ùå Exception: ${error}`);
    } finally {
      console.log('üß™ [Test] Create account test completed');
      setLoading(false);
    }
  };

  const testCheckAccountStatus = async () => {
    console.log('üß™ [Test] Starting account status check...');
    setLoading(true);
    setResult('üîÑ Checking account status...');

    try {
      console.log('üß™ [Test] Getting session for auth...');
      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData.session?.access_token;
      
      if (!token) {
        throw new Error('No authentication token available');
      }
      
      console.log('üß™ [Test] Invoking check-stripe-account-status Edge Function...');
      
      const { data, error } = await supabase.functions.invoke('check-stripe-account-status', {
        headers: {
          Authorization: `Bearer ${token}`,
        },
        body: {} // No body needed, function gets user from auth header
      });

      console.log('üß™ [Test] Status check response:', { data, error });

      if (error) {
        console.log('‚ùå [Test] Error from status check:', error);
        setResult(`‚ùå Error: ${error.message}`);
      } else {
        console.log('‚úÖ [Test] Status check successful');
        console.log('üìä [Test] Account data:', data);
        setResult(`‚úÖ Status: ${JSON.stringify(data, null, 2)}`);
      }
    } catch (error) {
      console.log('üí• [Test] Exception in status check:', error);
      setResult(`‚ùå Exception: ${error}`);
    } finally {
      console.log('üß™ [Test] Status check test completed');
      setLoading(false);
    }
  };

  const testCreateOnboardingLink = async () => {
    console.log('üß™ [Test] Starting onboarding link creation...');
    
    // First get the user's Stripe account ID
    console.log('üß™ [Test] Fetching user profile for Stripe account ID...');
    const { data: profile } = await supabase
      .from('profiles')
      .select('stripe_account_id')
      .eq('id', user?.id)
      .single();

    console.log('üß™ [Test] Profile data:', profile);

    if (!profile?.stripe_account_id) {
      console.log('‚ùå [Test] No Stripe account found in profile');
      setResult('‚ùå No Stripe account found. Create one first.');
      return;
    }

    console.log('üß™ [Test] Found Stripe account:', profile.stripe_account_id);
    setLoading(true);
    setResult('üîÑ Creating onboarding link...');

    try {
      console.log('üß™ [Test] Invoking create-stripe-onboarding-link Edge Function...');
      const requestBody = { 
        account_id: profile.stripe_account_id,
        refresh_url: 'zova://test',
        return_url: 'zova://test'
      };
      console.log('üß™ [Test] Request body:', requestBody);

      const { data, error } = await supabase.functions.invoke('create-stripe-onboarding-link', {
        body: requestBody
      });

      console.log('üß™ [Test] Onboarding link response:', { data, error });

      if (error) {
        console.log('‚ùå [Test] Error creating onboarding link:', error);
        setResult(`‚ùå Error: ${error.message}`);
      } else {
        console.log('‚úÖ [Test] Onboarding link created successfully');
        console.log('üîó [Test] Link URL:', data.url);
        setResult(`‚úÖ Link created: ${data.url}`);
      }
    } catch (error) {
      console.log('üí• [Test] Exception in onboarding link creation:', error);
      setResult(`‚ùå Exception: ${error}`);
    } finally {
      console.log('üß™ [Test] Onboarding link test completed');
      setLoading(false);
    }
  };

  const testDatabaseQueries = async () => {
    console.log('üß™ [Test] Starting database queries test...');
    setLoading(true);
    setResult('üîÑ Testing database queries...');

    try {
      // Test profiles query
      console.log('üß™ [Test] Querying profiles table...');
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user?.id)
        .single();

      console.log('üß™ [Test] Profiles query result:', { profile, profileError });

      if (profileError) {
        console.log('‚ùå [Test] Profile query error:', profileError);
        setResult(`‚ùå Profile Error: ${profileError.message}`);
        return;
      }

      // Test provider_payouts query
      console.log('üß™ [Test] Querying provider_payouts table...');
      const { data: payouts, error: payoutsError } = await supabase
        .from('provider_payouts')
        .select('*')
        .eq('provider_id', user?.id)
        .limit(5);

      console.log('üß™ [Test] Payouts query result:', { payouts, payoutsError });

      if (payoutsError) {
        console.log('‚ùå [Test] Payouts query error:', payoutsError);
        setResult(`‚ùå Payouts Error: ${payoutsError.message}`);
        return;
      }

      console.log('‚úÖ [Test] Database queries successful');
      console.log('üìä [Test] Profile found:', !!profile);
      console.log('üìä [Test] Stripe account:', profile?.stripe_account_id || 'None');
      console.log('üìä [Test] Payouts count:', payouts?.length || 0);

      setResult(`‚úÖ Database Test Success:
Profile: ${profile ? 'Found' : 'Not found'}
Stripe Account: ${profile?.stripe_account_id || 'None'}
Payouts: ${payouts?.length || 0} found`);
    } catch (error) {
      console.log('üí• [Test] Exception in database queries:', error);
      setResult(`‚ùå Exception: ${error}`);
    } finally {
      console.log('üß™ [Test] Database queries test completed');
      setLoading(false);
    }
  };

  const openStripeOnboarding = async () => {
    console.log('üîó [Stripe] Opening fresh onboarding link...');
    setLoading(true);
    
    try {
      // First get the user's Stripe account ID
      const { data: profile } = await supabase
        .from('profiles')
        .select('stripe_account_id')
        .eq('id', user?.id)
        .single();

      if (!profile?.stripe_account_id) {
        console.log('‚ùå [Stripe] No Stripe account found');
        setResult('‚ùå No Stripe account found. Create one first.');
        setLoading(false);
        return;
      }

      console.log('üîó [Stripe] Creating fresh onboarding link for:', profile.stripe_account_id);
      
      // Create a fresh onboarding link
      const { data, error } = await supabase.functions.invoke('create-stripe-onboarding-link', {
        body: { 
          account_id: profile.stripe_account_id,
          refresh_url: 'https://zova.app/stripe-refresh',
          return_url: 'https://zova.app/stripe-complete'
        }
      });

      if (error) {
        console.log('‚ùå [Stripe] Error creating link:', error);
        setResult(`‚ùå Error: ${error.message}`);
        setLoading(false);
        return;
      }

      console.log('‚úÖ [Stripe] Fresh link created:', data.url);
      console.log('üåê [Stripe] Opening in browser...');
      
      // Open in web browser
      await WebBrowser.openBrowserAsync(data.url, {
        presentationStyle: WebBrowser.WebBrowserPresentationStyle.FULL_SCREEN,
      });
      
      setResult(`‚úÖ Opened fresh onboarding link in browser\n\nAccount: ${profile.stripe_account_id}`);
    } catch (error) {
      console.log('üí• [Stripe] Exception:', error);
      setResult(`‚ùå Exception: ${error}`);
    } finally {
      setLoading(false);
    }
  };

  const checkDetailedAccountStatus = async () => {
    console.log('üîç [Status] Starting detailed account status check...');
    setLoading(true);
    setResult('üîÑ Checking detailed account status...');

    try {
      // First get profile data
      const { data: profile } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user?.id)
        .single();

      if (!profile) {
        setResult('‚ùå No profile found');
        setLoading(false);
        return;
      }

      console.log('üìä [Status] Profile data:', profile);
      
      if (!profile.stripe_account_id) {
        setResult('‚ùå No Stripe account ID in profile');
        setLoading(false);
        return;
      }

      // Check account status via Edge Function
      console.log('üîç [Status] Getting session for auth...');
      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData.session?.access_token;
      
      if (!token) {
        throw new Error('No authentication token available');
      }
      
      const { data: statusData, error: statusError } = await supabase.functions.invoke('check-stripe-account-status', {
        headers: {
          Authorization: `Bearer ${token}`,
        },
        body: {} // No body needed, function gets user from auth header
      });

      console.log('üìä [Status] Account status response:', { statusData, statusError });

      if (statusError) {
        console.log('‚ùå [Status] Error from status check:', statusError);
        setResult(`‚ùå Status Check Error: ${statusError.message}`);
        return;
      }

      // Format detailed status
      const statusInfo = `‚úÖ DETAILED ACCOUNT STATUS

üë§ Profile Info:
‚Ä¢ Name: ${profile.full_name || 'Not set'}
‚Ä¢ Email: ${profile.email || 'Not set'}
‚Ä¢ Role: ${profile.role || 'Not set'}

üí≥ Stripe Account:
‚Ä¢ Account ID: ${profile.stripe_account_id}
‚Ä¢ Status: ${statusData ? JSON.stringify(statusData, null, 2) : 'No status data'}

üìä Verification:
‚Ä¢ Onboarding: ${profile.onboarding_complete ? '‚úÖ Complete' : '‚ùå Incomplete'}
‚Ä¢ Verified: ${profile.is_verified ? '‚úÖ Yes' : '‚ùå No'}`;

      console.log('‚úÖ [Status] Detailed status compiled');
      setResult(statusInfo);

    } catch (error) {
      console.log('üí• [Status] Exception:', error);
      setResult(`‚ùå Exception: ${error}`);
    } finally {
      setLoading(false);
    }
  };

  const checkDatabaseSync = async () => {
    console.log('üîÑ [Sync] Checking database sync with Stripe status...');
    setLoading(true);
    setResult('üîÑ Verifying database sync...');

    try {
      // Get profile data
      const { data: profile } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user?.id)
        .single();

      if (!profile) {
        setResult('‚ùå No profile found');
        setLoading(false);
        return;
      }

      // Get Stripe status
      console.log('üîÑ [Sync] Getting session for auth...');
      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData.session?.access_token;
      
      if (!token) {
        throw new Error('No authentication token available');
      }
      
      const { data: statusData, error: statusError } = await supabase.functions.invoke('check-stripe-account-status', {
        headers: {
          Authorization: `Bearer ${token}`,
        },
        body: {}
      });

      if (statusError) {
        setResult(`‚ùå Status Check Error: ${statusError.message}`);
        return;
      }

      // Compare database vs Stripe
      const syncStatus = `üîÑ DATABASE SYNC VERIFICATION

üìä DATABASE STATUS:
‚Ä¢ Account Status: ${profile.stripe_account_status || 'null'}
‚Ä¢ Charges Enabled: ${profile.stripe_charges_enabled ? '‚úÖ' : '‚ùå'}
‚Ä¢ Details Submitted: ${profile.stripe_details_submitted ? '‚úÖ' : '‚ùå'}

üîó STRIPE REALITY:
‚Ä¢ Account Status: ${statusData.hasStripeAccount ? 'active' : 'none'}
‚Ä¢ Charges Enabled: ${statusData.charges_enabled ? '‚úÖ' : '‚ùå'}
‚Ä¢ Details Submitted: ${statusData.details_submitted ? '‚úÖ' : '‚ùå'}

‚úÖ SYNC STATUS:
‚Ä¢ Account Status: ${profile.stripe_account_status === 'active' && statusData.hasStripeAccount ? '‚úÖ SYNCED' : '‚ùå OUT OF SYNC'}
‚Ä¢ Charges: ${profile.stripe_charges_enabled === statusData.charges_enabled ? '‚úÖ SYNCED' : '‚ùå OUT OF SYNC'}
‚Ä¢ Details: ${profile.stripe_details_submitted === statusData.details_submitted ? '‚úÖ SYNCED' : '‚ùå OUT OF SYNC'}

üéØ ACCOUNT ID: ${statusData.accountId}
üìÖ Last Updated: ${new Date(profile.updated_at).toLocaleString()}`;

      console.log('‚úÖ [Sync] Database sync verification completed');
      setResult(syncStatus);

    } catch (error) {
      console.log('üí• [Sync] Exception:', error);
      setResult(`‚ùå Exception: ${error}`);
    } finally {
      setLoading(false);
    }
  };

  const createFreshStripeAccount = async () => {
    console.log('üÜï [Fresh] Creating completely fresh Stripe account...');
    setLoading(true);
    setResult('üîÑ Creating fresh Stripe account for testing...');

    try {
      if (!user?.id) {
        setResult('‚ùå No user logged in');
        setLoading(false);
        return;
      }

      // First clear any existing Stripe account reference
      console.log('üÜï [Fresh] Clearing existing Stripe account reference...');
      await supabase
        .from('profiles')
        .update({ stripe_account_id: null })
        .eq('id', user.id);

      console.log('üÜï [Fresh] Creating new Stripe account...');
      const { data, error } = await supabase.functions.invoke('create-stripe-account', {
        body: { user_id: user.id }
      });

      if (error) {
        console.log('‚ùå [Fresh] Error creating fresh account:', error);
        setResult(`‚ùå Error: ${error.message}`);
        setLoading(false);
        return;
      }

      console.log('‚úÖ [Fresh] Fresh account created successfully!');
      console.log('üÜï [Fresh] New Account ID:', data.stripeAccountId);
      console.log('üîó [Fresh] Fresh Onboarding URL:', data.accountLink);

      const freshSuccessMessage = `‚úÖ FRESH STRIPE ACCOUNT CREATED!

üÜï New Account ID: ${data.stripeAccountId}
üí∞ Commission: ${data.commissionRate}
üìÖ Payout: ${data.payoutSchedule}
üí∑ Minimum: ${data.minimumPayout}

üîó Fresh Onboarding URL:
${data.accountLink}

‚ú® This is a completely new account - use the test values below!`;
      
      setResult(freshSuccessMessage);
      setLastCreateResult(data.stripeAccountId);

    } catch (error) {
      console.log('üí• [Fresh] Exception:', error);
      setResult(`‚ùå Exception: ${error}`);
    } finally {
      setLoading(false);
    }
  };

  return (
    <SafeAreaView className="flex-1 bg-background" edges={['top']}>
      {/* Header */}
      <View className="flex-row items-center justify-between px-6 py-4 border-b border-border">
        <TouchableOpacity onPress={() => {
          console.log('üß™ [Navigation] Back button pressed');
          router.back();
        }}>
          <Text className="text-lg">‚Üê</Text>
        </TouchableOpacity>
        <Text className="text-lg font-semibold text-foreground">Stripe Test</Text>
        <View className="w-6" />
      </View>

      <ScrollView className="flex-1 p-6">
        <View className="space-y-6">
          {/* Test Actions */}
          <Card>
            <CardHeader>
              <CardTitle>Stripe Integration Tests</CardTitle>
              <Text className="text-sm text-muted-foreground">
                Use proper test values for successful onboarding
              </Text>
            </CardHeader>
            <CardContent className="space-y-4">
              <Button 
                onPress={() => {
                  console.log('üß™ [Button] Create Stripe Account test button pressed');
                  testCreateStripeAccount();
                }}
                disabled={loading}
                className="w-full"
              >
                <Text className="text-primary-foreground font-medium">
                  Test Create Stripe Account
                </Text>
              </Button>

              <Button 
                onPress={() => {
                  console.log('üÜï [Button] Create Fresh Stripe Account button pressed');
                  createFreshStripeAccount();
                }}
                disabled={loading}
                variant="destructive"
                className="w-full"
              >
                <Text className="text-destructive-foreground font-medium">
                  üÜï Create Fresh Account (Clears Old)
                </Text>
              </Button>

              <Button 
                onPress={() => {
                  console.log('üß™ [Button] Check Account Status test button pressed');
                  testCheckAccountStatus();
                }}
                disabled={loading}
                variant="outline"
                className="w-full"
              >
                <Text className="font-medium">
                  Test Check Account Status
                </Text>
              </Button>

              <Button 
                onPress={() => {
                  console.log('üîç [Button] Detailed Account Status button pressed');
                  checkDetailedAccountStatus();
                }}
                disabled={loading}
                variant="outline"
                className="w-full"
              >
                <Text className="font-medium">
                  üîç Detailed Account Status
                </Text>
              </Button>

              <Button 
                onPress={() => {
                  console.log('üß™ [Button] Create Onboarding Link test button pressed');
                  testCreateOnboardingLink();
                }}
                disabled={loading}
                variant="outline"
                className="w-full"
              >
                <Text className="font-medium">
                  Test Create Onboarding Link
                </Text>
              </Button>

              <Button 
                onPress={() => {
                  console.log('üß™ [Button] Database Queries test button pressed');
                  testDatabaseQueries();
                }}
                disabled={loading}
                variant="outline"
                className="w-full"
              >
                <Text className="font-medium">
                  Test Database Queries
                </Text>
              </Button>

              <Button 
                onPress={() => {
                  console.log('üîó [Button] Open Stripe Onboarding button pressed');
                  openStripeOnboarding();
                }}
                disabled={loading}
                variant="secondary"
                className="w-full"
              >
                <Text className="font-medium">
                  üåê Open Stripe Onboarding
                </Text>
              </Button>
            </CardContent>
          </Card>

          {/* Success Message */}
          {lastCreateResult && (
            <Card className="mt-4 border-green-500 bg-green-50 dark:bg-green-950">
              <CardContent className="p-4">
                <Text variant="h3" className="mb-2 text-green-700 dark:text-green-300">
                  üéâ Onboarding Complete!
                </Text>
                <Text className="text-green-600 dark:text-green-400 mb-3">
                  Your Stripe account setup was successful. Click "Check Account Status" to verify your account details.
                </Text>
                <Button
                  onPress={checkDetailedAccountStatus}
                  className="bg-green-600 active:bg-green-700 mb-3"
                >
                  <Text className="text-white font-medium">
                    ‚úÖ Verify Account Status
                  </Text>
                </Button>

                <Button
                  onPress={checkDatabaseSync}
                  className="bg-blue-600 active:bg-blue-700"
                >
                  <Text className="text-white font-medium">
                    üîÑ Check Database Sync
                  </Text>
                </Button>
              </CardContent>
            </Card>
          )}

          {/* Test Values Guide */}
          <Card>
            <CardHeader>
              <CardTitle>üìã Test Values for Stripe Onboarding</CardTitle>
              <Text className="text-sm text-muted-foreground">
                Use these values for successful test onboarding
              </Text>
            </CardHeader>
            <CardContent className="space-y-3">
              <View className="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded border border-yellow-200 dark:border-yellow-800">
                <Text className="text-sm font-bold text-yellow-800 dark:text-yellow-200 mb-2">
                  üö® CRITICAL: Phone Number Step
                </Text>
                <Text className="text-xs text-yellow-700 dark:text-yellow-300">
                  1. When you see phone number form, look for:
                  {'\n'}2. "Skip this with a test phone number" 
                  {'\n'}3. Click "Use test phone number"
                  {'\n'}4. DO NOT enter any real phone number!
                </Text>
              </View>

              <View className="space-y-1">
                <Text className="text-sm font-medium">üìû Phone Number:</Text>
                <Text className="text-sm font-mono bg-muted p-2 rounded">
                  000-000-0000 (Use SKIP option instead!)
                </Text>
              </View>
              
              <View className="space-y-1">
                <Text className="text-sm font-medium">üìß Email:</Text>
                <Text className="text-sm font-mono bg-muted p-2 rounded">
                  test@example.com
                </Text>
              </View>
              
              <View className="space-y-1">
                <Text className="text-sm font-medium">üÜî SSN/TIN:</Text>
                <Text className="text-sm font-mono bg-muted p-2 rounded">
                  000-00-0000
                </Text>
              </View>
              
              <View className="space-y-1">
                <Text className="text-sm font-medium">üìÖ Date of Birth:</Text>
                <Text className="text-sm font-mono bg-muted p-2 rounded">
                  01/01/1970
                </Text>
              </View>
              
              <View className="space-y-1">
                <Text className="text-sm font-medium">üè† Address:</Text>
                <Text className="text-sm font-mono bg-muted p-2 rounded">
                  address_full_match
                </Text>
              </View>

              <View className="space-y-1">
                <Text className="text-sm font-medium">üè¢ Business Name:</Text>
                <Text className="text-sm font-mono bg-muted p-2 rounded">
                  Test Business
                </Text>
              </View>

              <Text className="text-xs text-muted-foreground">
                ‚úÖ Perfect for UK marketplace without needing UK phone number!
              </Text>
            </CardContent>
          </Card>

          {/* Test Results */}
          {result && (
            <Card>
              <CardHeader>
                <CardTitle>Test Results</CardTitle>
              </CardHeader>
              <CardContent>
                <Text className="text-sm font-mono bg-muted p-4 rounded">
                  {result}
                </Text>
              </CardContent>
            </Card>
          )}

          {/* User Info */}
          <Card>
            <CardHeader>
              <CardTitle>Current User</CardTitle>
            </CardHeader>
            <CardContent>
              <Text className="text-sm text-muted-foreground">
                ID: {user?.id || 'Not logged in'}
              </Text>
              <Text className="text-sm text-muted-foreground">
                Email: {user?.email || 'N/A'}
              </Text>
            </CardContent>
          </Card>

          {/* Navigation */}
          <Card>
            <CardHeader>
              <CardTitle>Quick Navigation</CardTitle>
            </CardHeader>
            <CardContent className="space-y-2">
              <Button 
                onPress={() => {
                  console.log('üß™ [Navigation] Going to Payment Setup page');
                  router.push('/provider-verification/payment');
                }}
                variant="outline"
                className="w-full"
              >
                <Text>Go to Payment Setup</Text>
              </Button>
              
              <Button 
                onPress={() => {
                  console.log('üß™ [Navigation] Going to Earnings page');
                  router.push('/provider/earnings');
                }}
                variant="outline"
                className="w-full"
              >
                <Text>Go to Earnings</Text>
              </Button>
            </CardContent>
          </Card>
        </View>
      </ScrollView>
    </SafeAreaView>
  );
}